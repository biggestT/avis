<!DOCTYPE html>
 
<html>
<head>
	<meta charset="utf-8"/>
	<meta name="description" content="Audio Visualizer">
	<meta name="keywords" content="joy division, audio, visualization,Web audio ,JavaScript">
	<meta name="author" content="Tor Nilsson Ã–hrn">
    <title>AVis</title>
    <script type="text/javascript" src="js/jquery-1.8.3.min.js"></script>
    <script type="text/javascript" src="js/glMatrix-0.9.5.min.js"></script>
    <script type="text/javascript" src="js/avisViewer.js"></script>
    <script type="text/javascript" src="js/glViewer.js"></script>
    <script type="text/javascript" src="js/avisModel.js"></script>
    <script type="text/javascript" src="js/observerList.js"></script>
    <script type="text/javascript" src="js/cameracontroller.js"></script>
    <script type="text/javascript" src="js/remoteAudioPlayer.js"></script>

	<link type="text/css" rel="stylesheet" href="avis.css">
	<script id="shader-fs" type="x-shader/x-fragment">
    precision mediump float;

    void main(void) {
      gl_FragColor = vec4(1.0, 0.5, 1.0, 1.0);
    }
	</script>

	<script id="shader-vs" type="x-shader/x-vertex">
    attribute vec3 aVertexPosition;

    uniform mat4 uMVMatrix;
    uniform mat4 uPMatrix;

    void main(void) {
      gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
    }
	</script>
	<script type="text/javascript">
	var context;
	var model;
	var audio;
	var currentTime = 0;

	function initialize() {
	  	context = new webkitAudioContext();

	  	// Setup frequency model
	  	model = new AvisModel(1024, 30, context);
	  	console.log(model);

	  	// Setup different viewers
	  	consoleViewer = new ConsoleViewer();
	  	console.log(consoleViewer);
	  	flatViewer = new FlatViewer( 'canvas1' );
	  	flatViewer.getCanvasContext().fillStyle = 'rgb(250, 250, 250)';
	  	glViewer = new GlViewer( 'canvas2' );
	  	console.log(glViewer);
	  	// glViewer.getCanvasContext().fillStyle = 'rgb(250, 250, 250)';
	  	circleViewer = new CircleViewer( 'canvas3' );
	  	circleViewer.getCanvasContext().fillStyle = 'rgb(250, 250, 250)';
	  	// Connect the different views to the model
	  	model.addObserver( circleViewer );
	  	model.addObserver( flatViewer );
	  	model.addObserver( glViewer );
	  	model.addObserver( consoleViewer );

		// Load MP3 with RemoteAudioPlayer by https://github.com/0xfe 
		audio = new RemoteAudioPlayer( context, 'audio/klaymen-curious.ogg' );
		audio.load(function() {
			$('#play').text("Play");
			$('#play').click(play);
		});
	}

	function play() {
		
		var source = audio.getSource();
  	var analyser = model.getAnalyser();
	  // Connect nodes for routing
	  source.connect(analyser);
	  source.connect(context.destination);
		
	  // Play audio
	  audio.reload();
	  // paus function not working atm
	  source.noteOn(currentTime, -0.2);

	  // Enable graphs
	  model.enable();

	  $('#play').text("Stop");
	  $('#play').click(stop);
	}

	function stop() {
		// save current time
		currentTime = context.currentTime;
		//console.log(currentTime);
	  // Disable visualisation and sound
	  model.disable();
		audio.getSource().disconnect();

	  $('#play').text("Play");
	  $('#play').click(play);
	}

	// starts everything when page is loaded
	$(function() { initialize(); });

	</script>
</head>
<body>
	<div id="play"></div>
	<canvas id="canvas1" width="600" height="300"></canvas>
	<canvas id="canvas2" width="500" height="500"></canvas>
	<canvas id="canvas3" width="600" height="300"></canvas>
</body>
</html>