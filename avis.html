<!DOCTYPE html>
 
<html>
<head>

	<meta charset="utf-8"/>
	<meta name="description" content="Audio Visualizer">
	<meta name="keywords" content="joy division, audio, visualization,Web audio ,JavaScript">
	<meta name="author" content="Tor Nilsson Öhrn">
    <title>AVis</title>
    <script type="text/javascript" src="js/jquery-1.8.3.min.js"></script>
    <script type="text/javascript" src="js/glMatrix-0.9.5.min.js"></script>
    <script type="text/javascript" src="js/webgl-utils.js"></script>
    <script type="text/javascript" src="js/observerList.js"></script>
    <script type="text/javascript" src="js/avisViewer.js"></script>
    <script type="text/javascript" src="js/glViewer.js"></script>
    <script type="text/javascript" src="js/avisModel.js"></script>
    
    <script type="text/javascript" src="js/cameracontroller.js"></script>

	<link type="text/css" rel="stylesheet" href="avis.css">
	<script id="shader-fs" type="x-shader/x-fragment">
    precision mediump float;
    varying vec4 vColor;

    void main(void) {
      gl_FragColor = vColor;
    }
	</script>

	<script id="shader-vs" type="x-shader/x-vertex">
    attribute vec3 aVertexPosition;
    attribute vec4 aVertexColor;

    varying vec4 vColor;

    uniform mat4 model;
    uniform mat4 projection;
    // uniform mat4 view;

    void main(void) {
      gl_Position = projection  * model  * vec4(aVertexPosition, 1.0);
      vColor = aVertexColor;
    }
	</script>
	<script type="text/javascript">
	var context;
	var audioAnalyser;
	var currentTime = 0;

// Run animation loop 
	function tick() {
		requestAnimFrame(tick);
		glViewer.drawScene();
		}
	function initialize() {

			audio = new Audio();
			audio.src = 'https://api.soundcloud.com/tracks/293/stream.json?client_id=8acdc76bf6b2d52bce4ec1f2ad4f07bc';
			// audio.src = 'http://api.soundcloud.com/resolve.json?url=http://soundcloud.com/swagistin/lil-wayne-a-milli&client_id=8acdc76bf6b2d52bce4ec1f2ad4f07bc';
			audio.controls = true;
			audio.autoplay = false;
			$('#player').append(audio);
			$('#player').hide();
			// $(audio).hide();
	  	context = new webkitAudioContext();
	  	
	  	// Setup frequency auardioAnalyser
	  	audioAnalyser = new AvisModel(512, 25, context);
	  	console.log(audioAnalyser);


	  	glViewer = new GlViewer( 'canvas1', audioAnalyser.bands, 40 );

	  	audioAnalyser.addObserver( glViewer );

			$('#start').text("Start Application");
			$('#start').click(play);
	}
	

	function play() {
				
			source = context.createMediaElementSource(audio);
			console.log(source);
	  	var analyser = audioAnalyser.getAnalyser();

		  // Connect nodes for routing
		  source.connect(analyser);
		  source.connect(context.destination);
		  
		  audioAnalyser.enable();
		  audio.play();
			tick();
			$('#start').hide();
			$('#player').show();
	}

	function stop() {
		// save current time
		currentTime = context.currentTime;
		//console.log(currentTime);
	  // Disable visualisation and sound
	  audioAnalyser.disable();
	  audio.stop();
	  $('#play').text("Play");
	  $('#play').click(play);
	}

	// starts everything when page is loaded
	$(function() { 

		initialize(); 
	});

	</script>
</head>
<body>
	<div id="start"></div>
	<div id="player"></div>
	<canvas id="canvas1" width="600" height="300"></canvas>
	<div id="text">
		<p> <a href="https://github.com/biggestT/avis">SourceCode (work in progress)</a></p>
		</br></br>
		<p>Put together by <a href="http://tornilssonohrn.com">Tor Nilsson Öhrn</a></p>
		<p>Music by <a href="https://soundcloud.com/klaymen-1">Klaymen</a></p>
		<p>Original idea by <a href="http://riseby.tumblr.com/">Emil Riseby</a></p>
		<p>Some parts of the code from:</p>
		<p><a href="http://0xfe.blogspot.se">0xFE</a></p>
		<p><a href="http://learningwebgl.com">Learning WebGL</a></p>
		<p><a href="https://github.com/cwilso">Chris Wilson</a></p>
	</div>
	<!-- <canvas id="canvas2" width="600" height="300"></canvas> -->
	<!-- <canvas id="canvas3" width="600" height="300"></canvas> -->

</body>

</html>