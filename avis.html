<!DOCTYPE html>
 
<html>
<head>

	<meta charset="utf-8"/>
	<meta name="description" content="Audio Visualizer">
	<meta name="keywords" content="joy division, audio, visualization,Web audio ,JavaScript">
	<meta name="author" content="Tor Nilsson Öhrn">
    <title>AVis</title>
    <link type="text/css" href="css/smoothness/jquery-ui-1.9.2.custom.css" rel="stylesheet">
    <link type="text/css"href="css/avis.css"  rel="stylesheet" >

    <script type="text/javascript" src="js/jquery-1.8.3.min.js"></script>
		<script type="text/javascript" src="js/jquery-ui-1.9.2.custom.js"></script>
    <script type="text/javascript" src="js/glMatrix-0.9.5.min.js"></script>
    <script type="text/javascript" src="js/webgl-utils.js"></script>
    <script type="text/javascript" src="js/observerList.js"></script>
    <script type="text/javascript" src="js/avisViewer.js"></script>
    <script type="text/javascript" src="js/glViewer.js"></script>
    <script type="text/javascript" src="js/avisModel.js"></script>
    <script type="text/javascript" src="js/cameracontroller.js"></script>
     <script type="text/javascript" src="js/jquery.formdefaults.js"></script>

	
	<script id="shader-fs" type="x-shader/x-fragment">
    precision mediump float;
    varying vec4 vColor;

    void main(void) {
      gl_FragColor = vColor;
    }
	</script>

	<script id="shader-vs" type="x-shader/x-vertex">
    attribute vec3 aVertexPosition;
    attribute vec4 aVertexColor;

    varying vec4 vColor;

    uniform mat4 model;
    uniform mat4 projection;
    // uniform mat4 view;

    void main(void) {
      gl_Position = projection  * model  * vec4(aVertexPosition, 1.0);
      vColor = aVertexColor;
    }
	</script>
	<script type="text/javascript">
	var context;
	var audioAnalyser;
	var currentTime = 0;

// Run animation loop 
	function tick() {
		requestAnimFrame(tick);
		glViewer.drawScene();
		}
	function initialize() {
			$("#trackId").formDefaults();
			var trackNumber = $("#trackId").val();

			trackNumber = 74455115;
			$("#trackId").hide();
			console.log(trackNumber);
			
			audio = new Audio();
			audio.src = 'https://api.soundcloud.com/tracks/' + trackNumber + '/stream.json?client_id=8acdc76bf6b2d52bce4ec1f2ad4f07bc';
			
			// audio.src = 'http://api.soundcloud.com/resolve.json?url=http://soundcloud.com/swagistin/lil-wayne-a-milli&client_id=8acdc76bf6b2d52bce4ec1f2ad4f07bc';
			audio.controls = true;
			audio.autoplay = false;
			$('#player').append(audio);
			$('#player').hide();
			// $(audio).hide();
	  	context = new webkitAudioContext();
	  	
	  	// Setup frequency auardioAnalyser
	  	audioAnalyser = new AvisModel(512, 25, context);
	  	console.log(audioAnalyser);


	  	glViewer = new GlViewer( 'canvas1', audioAnalyser.bands, 40 );

	  	audioAnalyser.addObserver( glViewer );

	  	$('#accordion').accordion();
	  	$('#accordion').accordion( "option", "collapsible", true );
			$('#accordion').accordion( "option", "active", false );
	  	$('#accordion').hide();
	  	$('#canvas1').hide();
	  	$('#soundcloudLogo').hide();
	  	$('button').button();
			$('#mirroring').click(glViewer.changeType);
			$('#mirroring').hide();
			$('#startButton').text("Start Application");
			$('#startButton').click(play);
			
	}
	

	function play() {
				
			source = context.createMediaElementSource(audio);
			console.log(source);
	  	var analyser = audioAnalyser.getAnalyser();

		  // Connect nodes for routing
		  source.connect(analyser);
		  source.connect(context.destination);
		  
		  audioAnalyser.enable();
		  audio.play();
			tick();
			$('#soundcloudLogo').show();
			$('#accordion').show();
			$('#canvas1').show();
			$('#startButton').hide();
			$(".form-text").hide();
			$('#player').show();
	}

	function stop() {
		// save current time
		currentTime = context.currentTime;
		//console.log(currentTime);
	  // Disable visualisation and sound
	  audioAnalyser.disable();
	  audio.stop();
	  $('#play').text("Play");
	  $('#play').click(play);
	}

	// starts everything when page is loaded
	$(function() { 

		initialize(); 
	});

	</script>
</head>
<body>
	
	<div id="startMenu">
		<button id="startButton">A button element</button>
		<div>
			<input id="trackId" class="form-text form-default-value-processed" type="text" value="soundcloud track number" style="color: rgb(204, 204, 204);"/>
		</div>	
	</div> 
	
	<canvas id="canvas1" width="600" height="300"></canvas>
	
	<div id="player"></div>
	<div id="soundcloud">
		<img id="soundcloudLogo" src="images/soundcloud_logo_white.png" alt="soundcloud logo"/>
	</div>
	<div id="accordion">
		<h3>Settings</h3>
		<div>
			<p>Coming soon ...</p>
			<button class="settings" id="mirroring">Turn Mirroring On / Off</button>
		</div>
		<h3>Credits</h3>
		<div>
			<p>Put together by <a href="http://tornilssonohrn.com">Tor Nilsson Öhrn</a></p>
			<p>Music by <a href="https://soundcloud.com/klaymen-1">Klaymen</a></p>
			<p>Original idea by <a href="http://riseby.tumblr.com/">Emil Riseby</a></p>
			<p>Some parts of the code from:</p>
			<p><a href="http://0xfe.blogspot.se">0xFE</a></p>
			<p><a href="http://learningwebgl.com">Learning WebGL</a></p>
			<p><a href="https://github.com/cwilso">Chris Wilson</a></p>
			</br></br>
			<p> <a href="https://github.com/biggestT/avis">SourceCode (work in progress)</a></p>
			
		</div>
	</div>
	<!-- <canvas id="canvas2" width="600" height="300"></canvas> -->
	<!-- <canvas id="canvas3" width="600" height="300"></canvas> -->

</body>

</html>